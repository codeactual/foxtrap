#!/usr/bin/php
<?php
/**
 * Usage:
 *        foxtrap --file bookmarks-YY-MM-DD.json
 *
 * Steps taken:
 * - New bookmarks are added to the DB.
 * - Details (ex. tags/titles) about known bookmarks are updated.
 * - Bookmarks removed from FF are removed from DB if present.
 * - Bookmarks tagged as 'nosave' (only title/tags indexed) are flagged.
 * - Bookmarks are downloaded if content is not present in DB.
 * - Indexer is triggered.
 * - Cache is invalidated based changes detected during above.
 */

use \Foxtrap\Factory;

require __DIR__ . '/../src/LoadClasses.php';

$opts = getopt('', array('file:'));

// Pull in $config from config.php and push to Factory
$configFile = __DIR__ . '/../config/config.php';
if (!is_readable($configFile)) {
  exit("\n{$configFile} missing or unreadable.\n");
}
require $configFile;
$factory = new Factory();
$foxtrap = $factory->createInstance($config);

// Extract bookmarks from JSON --file
$imported = $foxtrap->jsonToArray(file_get_contents($opts['file']));

// Add/update their details
$latestVer = $foxtrap->registerMarks($imported);

// Avoid unnecessary downloads
$foxtrap->cleanup($latestVer);

// Download any recently added or retry those with cleared error states
$foxtrap->download();
