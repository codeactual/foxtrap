#!/usr/bin/php
<?php
/**
 * Usage:
 *        foxtrap --file bookmarks-YY-MM-DD.json
 *
 * Steps taken:
 * - New bookmarks are added to the DB.
 * - Details (ex. tags/titles) about known bookmarks are updated.
 * - Bookmarks removed from FF are removed from DB if present.
 * - Bookmarks tagged as 'nosave' (only title/tags indexed) are flagged.
 * - Bookmarks are downloaded if content is not present in DB.
 * - Indexer is triggered.
 * - Cache is invalidated based changes detected during above.
 */

use \Flow;
use \Foxtrap\Factory;

require_once __DIR__ . '/../src/Foxtrap/Factory.php';

$opts = getopt('', array('file:'));

// Pull in $config from config.php and push to Factory
$configFile = __DIR__ . '/../config.php';
if (!is_readable($configFile)) {
  exit("\n{$configFile} missing or unreadable.\n");
}
require_once $configFile;
$factory = new Factory();
$foxtrap = $factory->createInstance($config);

// Extract bookmarks from JSON --file
$imported = $foxtrap->import($opts['file']);

// Add/update their details
$foxtrap->registerMarks($imported['marks'], $imported['tags'], $db);

// Download any recently added or retry those with cleared error states
$marks = $foxtrap->getMarksToDownload();
if ($marks) {
  $lastIdSeen = null;
  foreach ($marks as $mark) {
    error_log("+ {$mark['uri']}");
    $markDownloader->add($mark['uri'], $mark);
    $lastIdSeen = $mark['id'];
  }
  Flow::setMaxRuntime($markDownloader, 2 * count($marks));
  $latestVer = $db->getMarkVersion($lastIdSeen);
  $db->pruneRemovedMarks($latestVer);
  $this->flagNonDownloadable();

  $markDownloader->exec();
}
