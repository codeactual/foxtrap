#!/usr/bin/php
<?php

use \Flow;
use \Foxtrap\Factory;

require_once __DIR__ . '/../src/Foxtrap/Db/Factory.php';

$opts = getopt('', array('file:'));

// Add $config to namespace
$configFile = __DIR__ . '/../config.php';
if (!is_readable($configFile)) {
  exit("\n{$configFile} missing or unreadable.\n");
}
require_once $configFile;

$factory = new Factory();
$foxtrap = $factory->createInstance($config);

// Extract (unsorted) bookmarks from JSON file
$imported = $foxtrap->import($opts['file']);

// Call $db->register() for each bookmark
$foxtrap->registerMarks($imported['marks'], $imported['tags'], $db);

// Enqueue marks awaiting download
$marks = $foxtrap->getMarksToDownload();
if ($marks) {
  $lastIdSeen = null;
  foreach ($marks as $mark) {
    error_log("+ {$mark['uri']}");
    $markDownloader->add($mark['uri'], $mark);
    $lastIdSeen = $mark['id'];
  }
  Flow::setMaxRuntime($markDownloader, 2 * count($marks));
  $latestVer = $db->getMarkVersion($lastIdSeen);
  $db->pruneRemovedMarks($latestVer);
  $this->flagNonDownloadable();

  $markDownloader->exec();
}
