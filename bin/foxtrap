#!/usr/bin/php
<?php

use \Foxtrap\Factory;

require __DIR__ . '/../src/LoadClasses.php';

$factory = new Factory();
$foxtrap = $factory->createInstance();

// Extract bookmarks from JSON --file
$opts = getopt('', array('file:'));
if (!is_readable($opts['file'])) {
  exit("Usage: foxtrap --file <JSON>\n");
}
$imported = $foxtrap->jsonToArray(file_get_contents($opts['file']));

// Add/update their details
$latestVer = $foxtrap->registerMarks($imported);

// Avoid unnecessary downloads
$foxtrap->cleanup($latestVer);

// Download any recently added or retry those with cleared error states
$foxtrap->download();

// Update FTS
$config = $factory->getConfigFromFile();
if ($config['sphinx']['autoindex']) {
  passthru(__DIR__ . '/foxtrap-indexer');
}
