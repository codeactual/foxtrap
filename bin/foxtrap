#!/usr/bin/php
<?php
/**
 * @TODO HTMLPurifier SerializerPath in $config
 * @TODO error checks / exceptions
 * @TODO add schema to repo (no table/database name)
 * @TODO config.php sets the table name (so tests can use diff table)
 * @TODO remove error_log use (some sort of loggable iface?)
 * @TODO all CurlyQueue options come from config.php
 * @TODO tests (use diff table)
 */

use \CurlyQueue;
use \Flow;
use \Foxtrap;
use \Foxtrap\Db\Factory;
use \HTMLPurifier;
use \HTMLPurifier_Config;

require_once __DIR__ . '/../src/Foxtrap.php';
require_once __DIR__ . '/../src/Foxtrap/Db/Factory.php';

$opts = getopt('', array('file:'));

// Add $config to namespace
$configFile = __DIR__ . '/../config.php';
if (!is_readable($configFile)) {
  exit("\n{$configFile} missing or unreadable.\n");
}
require_once $configFile;

$factory = new Factory();
$foxtrap = $factory->createInstance($config);

// Extract (unsorted) bookmarks from JSON file
$imported = $foxtrap->import($opts['file']);

// Call $db->register() for each bookmark
$foxtrap->registerMarks($imported['marks'], $imported['tags'], $db);

// Enqueue marks awaiting download
$marks = $foxtrap->getMarksToDownload();
if ($marks) {
  $lastIdSeen = null;
  foreach ($marks as $mark) {
    error_log("+ {$mark['uri']}");
    $markDownloader->add($mark['uri'], $mark);
    $lastIdSeen = $mark['id'];
  }
  Flow::setMaxRuntime($markDownloader, 2 * count($marks));
  $latestVer = $db->getMarkVersion($lastIdSeen);
  $db->pruneRemovedMarks($latestVer);

  $markDownloader->exec();
}
